<launch>
  <arg name="build_only" default="false" description="shutdown node after TensorRT engine file is built"/>
  <arg name="debug_mode" default="true" description="debug mode"/>
  <arg name="param_path" default="$(find-pkg-share autoware_camera_streampetr)/config/tensorrt_stream_petr.param.yaml"/>
  <let name="autoware_path" value="$(env HOME)/autoware.proj"/>
  <!-- <arg name="model_path" default="$(env HOME)/autoware_data/camera_streampetr"/> -->
  <arg name="model_path" default="$(var autoware_path)/src/streampetr/models"/>
  <arg name="rviz" default="false" description="launch rviz"/>
  <arg name="rviz_respawn" default="true" description="respawn rviz"/>
  <set_parameter name="use_sim_time" value="true"/>

  <!-- START: Image Transport Decompressor for independent nodetesting-->
  <arg name="param_file" default="$(find-pkg-share autoware_image_transport_decompressor)/config/image_transport_decompressor.param.yaml"/>

  <node pkg="autoware_image_transport_decompressor" exec="image_transport_decompressor_node" name="image_transport_decompressor_node_0">
    <remap from="~/input/compressed_image" to="/sensing/camera/camera8/image_raw/compressed"/>
    <remap from="~/output/raw_image" to="/sensing/camera/camera8/image_raw"/>
    <remap from="~/input/camera_info" to="/sensing/camera/camera8/camera_info"/>
    <param from="$(var param_file)" allow_substs="true"/>
  </node>

  <node pkg="autoware_image_transport_decompressor" exec="image_transport_decompressor_node" name="image_transport_decompressor_node_1">
    <remap from="~/input/compressed_image" to="/sensing/camera/camera0/image_raw/compressed"/>
    <remap from="~/output/raw_image" to="/sensing/camera/camera0/image_raw"/>
    <remap from="~/input/camera_info" to="/sensing/camera/camera0/camera_info"/>
    <param from="$(var param_file)" allow_substs="true"/>
  </node>

  <node pkg="autoware_image_transport_decompressor" exec="image_transport_decompressor_node" name="image_transport_decompressor_node_2">
    <remap from="~/input/compressed_image" to="/sensing/camera/camera6/image_raw/compressed"/>
    <remap from="~/output/raw_image" to="/sensing/camera/camera6/image_raw"/>
    <remap from="~/input/camera_info" to="/sensing/camera/camera6/camera_info"/>
    <param from="$(var param_file)" allow_substs="true"/>
  </node>

  <node pkg="autoware_image_transport_decompressor" exec="image_transport_decompressor_node" name="image_transport_decompressor_node_3">
    <remap from="~/input/compressed_image" to="/sensing/camera/camera10/image_raw/compressed"/>
    <remap from="~/output/raw_image" to="/sensing/camera/camera10/image_raw"/>
    <remap from="~/input/camera_info" to="/sensing/camera/camera10/camera_info"/>
    <param from="$(var param_file)" allow_substs="true"/>
  </node>

  <node pkg="autoware_image_transport_decompressor" exec="image_transport_decompressor_node" name="image_transport_decompressor_node_4">
    <remap from="~/input/compressed_image" to="/sensing/camera/camera7/image_raw/compressed"/>
    <remap from="~/output/raw_image" to="/sensing/camera/camera7/image_raw"/>
    <remap from="~/input/camera_info" to="/sensing/camera/camera7/camera_info"/>
    <param from="$(var param_file)" allow_substs="true"/>
  </node>

  <node pkg="autoware_image_transport_decompressor" exec="image_transport_decompressor_node" name="image_transport_decompressor_node_5">
    <remap from="~/input/compressed_image" to="/sensing/camera/camera9/image_raw/compressed"/>
    <remap from="~/output/raw_image" to="/sensing/camera/camera9/image_raw"/>
    <remap from="~/input/camera_info" to="/sensing/camera/camera9/camera_info"/>
    <param from="$(var param_file)" allow_substs="true"/>
  </node>
  <!-- END: Image Transport Decompressor -->

  <node pkg="autoware_camera_streampetr" exec="autoware_camera_streampetr_node" name="stream_petr" output="screen">
    <param from="$(var param_path)" allow_substs="true"/>
    <param name="build_only" value="$(var build_only)"/>
    <param name="debug_mode" value="$(var debug_mode)"/>
    <param name="model_params.backbone_path" value="$(var model_path)/simplify_extract_img_feat.onnx"/>
    <param name="model_params.head_path" value="$(var model_path)/simplify_pts_head_memory.onnx"/>
    <param name="model_params.position_embedding_path" value="$(var model_path)/simplify_position_embedding.onnx"/>
    <remap from="~/input/kinematic_state" to="/localization/kinematic_state"/>

    <!-- Image of ~/input/camerai will be the ith image in the model input -->
    <!-- ["CAM_FRONT", "CAM_BACK", "CAM_FRONT_LEFT", "CAM_BACK_LEFT", "CAM_FRONT_RIGHT", "CAM_BACK_RIGHT"]  -->
    <remap from="~/input/camera0/camera_info" to="/sensing/camera/camera8/camera_info"/>
    <remap from="~/input/camera1/camera_info" to="/sensing/camera/camera0/camera_info"/>
    <remap from="~/input/camera2/camera_info" to="/sensing/camera/camera6/camera_info"/>
    <remap from="~/input/camera3/camera_info" to="/sensing/camera/camera10/camera_info"/>
    <remap from="~/input/camera4/camera_info" to="/sensing/camera/camera7/camera_info"/>
    <remap from="~/input/camera5/camera_info" to="/sensing/camera/camera9/camera_info"/>

    <remap from="~/input/camera0/image" to="/sensing/camera/camera8/image_raw"/>
    <remap from="~/input/camera1/image" to="/sensing/camera/camera0/image_raw"/>
    <remap from="~/input/camera2/image" to="/sensing/camera/camera6/image_raw"/>
    <remap from="~/input/camera3/image" to="/sensing/camera/camera10/image_raw"/>
    <remap from="~/input/camera4/image" to="/sensing/camera/camera7/image_raw"/>
    <remap from="~/input/camera5/image" to="/sensing/camera/camera9/image_raw"/>
    <remap from="~/output/objects" to="/perception/object_recognition/camera_only/objects"/>
    
    <!-- <remap from="~/input/camera0/image/compressed" to="/sensing/camera/camera8/image_raw/compressed"/>
    <remap from="~/input/camera1/image/compressed" to="/sensing/camera/camera0/image_raw/compressed"/>
    <remap from="~/input/camera2/image/compressed" to="/sensing/camera/camera6/image_raw/compressed"/>
    <remap from="~/input/camera3/image/compressed" to="/sensing/camera/camera10/image_raw/compressed"/>
    <remap from="~/input/camera4/image/compressed" to="/sensing/camera/camera7/image_raw/compressed"/>
    <remap from="~/input/camera5/image/compressed" to="/sensing/camera/camera9/image_raw/compressed"/> -->

    <param name="anchor_camera_id" value="0" />   <!-- The forward pass begins once every anchor camera topic reaches. Choose this as the camera that causes the shortest differnce in min and max timestamp between cameras-->
    <param name="is_compressed_image" value="false" />   <!-- Whether the input image is compressed. -->
    <param name="is_distorted_image" value="true" />   <!-- Whether the input image is compressed. -->
    <param name="multithreading" value="false"/>
    <param name="downsample_factor" value="0.3"/>

  </node>
    <!-- Tools -->
  <arg name="rviz_config_name" default="perception.rviz" description="rviz config name"/>
  <arg name="rviz_config" default="$(find-pkg-share autoware_launch)/rviz/$(var rviz_config_name)" description="rviz config path"/>
  <group>
    <node
      pkg="rviz2"
      exec="rviz2"
      name="rviz2"
      output="screen"
      if="$(var rviz)"
      args="-d $(var rviz_config) -s $(find-pkg-share autoware_launch)/rviz/image/autoware.png"
      respawn="$(var rviz_respawn)"
    />
  </group>
</launch>